/*!
 * This file is autogenerated. Do not edit this file directly.
 */

import type { IGetOptions, IGetAllOptions } from '../models/CommonModels';
import type { IOperationResult } from '@microsoft/power-apps/data';
import type { AtividadefieldcontrolBase, Atividadefieldcontrol } from '../models/AtividadefieldcontrolModel';
import { dataSourcesInfo } from '../../../.power/schemas/appschemas/dataSourcesInfo';
import { getClient } from '@microsoft/power-apps/data';

export class AtividadefieldcontrolService {
  private static readonly dataSourceName = 'new_atividadefieldcontrols';
  private static readonly client = getClient(dataSourcesInfo);

  public static async create(record: Omit<AtividadefieldcontrolBase, never>): Promise<IOperationResult<Atividadefieldcontrol>> {
    const result = await AtividadefieldcontrolService.client.createRecordAsync<Omit<AtividadefieldcontrolBase, never>, Atividadefieldcontrol>(
      AtividadefieldcontrolService.dataSourceName,
      record
    );
    return result;
  }

  public static async update(id: string, changedFields: Partial<AtividadefieldcontrolBase>): Promise<IOperationResult<Atividadefieldcontrol>> {
    const result = await AtividadefieldcontrolService.client.updateRecordAsync<Partial<AtividadefieldcontrolBase>, Atividadefieldcontrol>(
      AtividadefieldcontrolService.dataSourceName,
      id.toString(),
      changedFields
    );
    return result;
  }

  public static async delete(id: string): Promise<void> {
    await AtividadefieldcontrolService.client.deleteRecordAsync(
      AtividadefieldcontrolService.dataSourceName,
      id.toString());
  }

  public static async get(id: string, options?: IGetOptions): Promise<IOperationResult<Atividadefieldcontrol>> {
    const result = await AtividadefieldcontrolService.client.retrieveRecordAsync<Atividadefieldcontrol>(
      AtividadefieldcontrolService.dataSourceName,
      id.toString(),
      options
    );
    return result;
  }

  public static async getAll(options?: IGetAllOptions): Promise<IOperationResult<Atividadefieldcontrol[]>> {
    const result = await AtividadefieldcontrolService.client.retrieveMultipleRecordsAsync<Atividadefieldcontrol>(
      AtividadefieldcontrolService.dataSourceName,
      options
    );
    return result;
  }

  /**
   * Busca simples para teste de conexão
   */
  public static async testConnection(): Promise<IOperationResult<Atividadefieldcontrol[]>> {
    console.log('[AtividadefieldcontrolService] Testando conexão com query simples...');
    const options: IGetAllOptions = {
      top: 5,
      orderBy: ['createdon desc'],
    };
    return AtividadefieldcontrolService.getAll(options);
  }

  /**
   * Busca atividades da semana com filtros equivalentes ao PowerFX
   * @param startDate Data inicial (Date ou string ISO)
   * @param weekCount Quantidade de semanas (default 1)
   */
  public static async getWeekActivities(startDate: Date | string, weekCount = 1): Promise<IOperationResult<Atividadefieldcontrol[]>> {
    // Garantir que temos um objeto Date
    const startDateObj = typeof startDate === 'string' ? new Date(startDate) : new Date(startDate);
    
    // Calcular data final
    const endDateObj = new Date(startDateObj);
    endDateObj.setDate(endDateObj.getDate() + weekCount * 7);
    
    // Formatar datas para OData (formato ISO sem milissegundos)
    const formatODataDate = (d: Date) => d.toISOString().split('.')[0] + 'Z';
    const start = formatODataDate(startDateObj);
    const end = formatODataDate(endDateObj);

    // Filtros OData baseados no PowerFX original:
    // T.Status = Active, !IsBlank(T.'Status Atividade'), 
    // T.'Status Atividade' <> "pending", T.'Status Atividade' <> "",
    // !IsBlank(T.Colaborador), !IsBlank(T.'Ordem de Serviço'),
    // T.'Ordem de Serviço'.'Tipo de Serviço' <> Ajuste de PTI (100000006),
    // T.'Ordem de Serviço'.'Tipo de Serviço' <> Desenho de PTI (100000005),
    // T.'Ordem de Serviço'.'Tipo de Serviço' <> Blank(),
    // filtros de data
    const filterParts = [
      // State = Active (statecode 0 = Ativo)
      "statecode eq 0",
      // Status da atividade não é nulo
      "new_status ne null",
      // Status da atividade não é vazio
      "new_status ne ''",
      // Status da atividade não é pending
      "new_status ne 'pending'",
      // Employee/Colaborador não é vazio
      "_new_employee_value ne null",
      // Ordem de Serviço não é vazia
      "_new_ordemdeservico_value ne null",
      // Tipo de Serviço da OS não é nulo (via navigation property)
      "new_OrdemdeServico/new_tipodeservico ne null",
      // Tipo de Serviço da OS não é Ajuste de PTI (100000006)
      "new_OrdemdeServico/new_tipodeservico ne 100000006",
      // Tipo de Serviço da OS não é Desenho de PTI (100000005)
      "new_OrdemdeServico/new_tipodeservico ne 100000005",
      // Agendamento no período
      `new_agendamento ge ${start}`,
      `new_agendamento lt ${end}`
    ];
    
    const filter = filterParts.join(' and ');

    // Removido select para buscar todos os campos disponíveis
    // Depois de identificar os campos corretos, podemos adicionar o select de volta

    const options: IGetAllOptions = {
      filter,
      orderBy: ['new_agendamento asc'],
    };
    
    console.log('[AtividadefieldcontrolService] Buscando atividades com filtro:', filter);
    
    return AtividadefieldcontrolService.getAll(options);
  }
}
